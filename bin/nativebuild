#!/bin/sh


system="$(uname)"
export FLAGS="-Os -fPIC"
if [ -e "/usr/bin/clang++" ]; then
    export CXX="clang++"
    export CC="clang"
else
    export CXX="g++"
    export CC="gcc"
fi

echo "System: $system"
echo "Compilers: $CC, $CXX"
echo "FLAGS: $FLAGS"
echo

check() {
    if [ "$1" = "0" ]; then
        echo "* $2 => Compiled Sucessfully"
    else
        echo "* $2 => Failure"
        exit 1
    fi
}


if [ "$system" = "FreeBSD" ]; then

    pref=""
    if [ $(uname -p) = "amd64" ]; then
        pref="-amd64"
    fi

    $CXX $FLAGS -shared lib/kickstart/usage_sys.cc -o lib/libusagesys${pref}.so -lutil -lprocstat -lkvm
    check $? "UsageSysLib"

    $CXX $FLAGS lib/kickstart/usage_check.cc -o usage_check lib/libusagesys${pref}.so -lutil -lprocstat -lkvm
    check $? "UsageSysCheck"

fi

$CXX $FLAGS lib/kickstart/shell.cc -o shell
check $? "UserShell"

if [ "$1" = "sh" ]; then
    exit
fi

$CXX $FLAGS -c lib/kickstart/core.cc -o lib/core.o
check $? "Core"

$CXX $FLAGS -c lib/kickstart/utils.cc -o lib/utils.o
check $? "Utils"

if [ "$system" = "Darwin" ]; then
    $CXX $FLAGS -arch i386 -arch x86_64 -shared lib/kickstart/stat.cc -o lib/libstat.dylib
    # $CXX -Os -fPIC -shared lib/kickstart/stat.cc -o lib/libstat.so
fi
check $? "StatLib"

$CXX $FLAGS lib/kickstart/kick.cc -o kick lib/core.o lib/utils.o
check $? "KickStart"

# rm -rf lib/*.o
