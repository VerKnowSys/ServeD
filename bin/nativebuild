#!/bin/sh


system="$(uname)"
ccache="$(which ccache)"

if [ "$ccache" != "" ]; then
    echo "ccache found"
    export CXX="ccache g++"
else
    echo "no ccache found"
    export CXX="g++"
fi

rm -rf lib/*.dylib *.dSYM spawn ctrlcli userspawn

check() {
    if [ "$1" = "0" ]; then
        echo "$2 compiled sucessfully"
    else
        echo "Failure"
        exit 1
    fi
}

$CXX -c -O2 -pipe -shared -fPIC lib/spawnlib_src/core.cc -o lib/core.o
check $? "Core"

$CXX -O2 -pipe -fPIC lib/spawnlib_src/spawn.cc -o spawn lib/core.o
check $? "Spawn"

$CXX -O2 -pipe -fPIC lib/spawnlib_src/userspawn.cc -o userspawn lib/core.o
check $? "UserSpawn"

# $CXX -O2 -pipe -fPIC lib/spawnlib_src/controlcli.cc -o ctrlcli lib/core.o

case $system in

    Darwin)
        $CXX -Wl -dynamic -dylib -shared -flat_namespace -undefined suppress -o lib/libsvdwrap.dylib lib/core.o
        check $? "Library"
        ;;

    FreeBSD)
        $CXX -Wl -dynamic -shared -flat_namespace -o lib/libsvdwrap.so lib/core.o
        result=$?
        if [ "$result" = "0" ]; then
            echo "Native library compiled sucessfully"
        else
            echo "Failure"
        fi
        ;;
        
esac

rm -rf lib/*.o
