#!/bin/sh


system="$(uname)"
# debug case: export CXX="ccache g++ -g"
export CXX="ccache g++"

echo "Cleaning"
rm -rf lib/*.o lib/*.so lib/*.dylib *.dSYM spawn ctrlcli userspawn


echo "Compiling library and binaries"
$CXX -c -O2 -pipe -shared -fPIC lib/spawnlib_src/core.cc -o lib/core.o
$CXX -O2 -pipe -fPIC lib/spawnlib_src/spawn.cc -o spawn lib/core.o
$CXX -O2 -pipe -fPIC lib/spawnlib_src/userspawn.cc -o userspawn lib/core.o
$CXX -O2 -pipe -fPIC lib/spawnlib_src/controlcli.cc -o ctrlcli lib/core.o

case $system in

    Darwin)
        $CXX -Wl -dynamic -dylib -shared -flat_namespace -undefined suppress -o lib/libsvdwrap.dylib lib/core.o
        file lib/libsvdwrap.dylib
        echo "Ready"
        ;;

    FreeBSD)
        $CXX -Wl -dynamic -shared -flat_namespace -o lib/libsvdwrap.so lib/core.o
        file lib/libsvdwrap.so
        echo "Ready"
        ;;
        
esac
