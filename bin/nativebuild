#!/bin/sh


system="$(uname)"
DEVEL="false"
FLAGS="-Os -fPIC"
CXX="g++"
STRIP="strip"


if [ -e "/usr/bin/clang++" ]; then
    CXX="clang++"
fi

echo "System: $system"
echo "Compiler: $CXX"
echo "Flags: $FLAGS"
echo "Devel: $DEVEL"
echo

check() {
    if [ "$1" = "0" ]; then
        echo "* $2 => Compiled Sucessfully"
        if [ "$DEVEL" != "true" ]; then
            if [ "$3" != "" ]; then
                echo "  Stripping $3"
                $STRIP $3
            fi
        fi
    else
        echo "* $2 => Failure"
        exit 1
    fi
}


$CXX $FLAGS -c lib/kickstart/core.cc -o lib/core.o
check $? "Core"

$CXX $FLAGS -c lib/kickstart/utils.cc -o lib/utils.o
check $? "Utils"

$CXX $FLAGS lib/kickstart/shell.cc -o shell
check $? "UserShell" "shell"

$CXX $FLAGS lib/kickstart/daemon.cc -o daemon
check $? "UserDaemon" "daemon"


$CXX $FLAGS lib/kickstart/kick.cc -o kick lib/core.o lib/utils.o
check $? "KickStart" "kick"

if [ "$system" = "FreeBSD" ]; then
    $CXX $FLAGS -shared lib/kickstart/usage_sys.cc -o lib/libusagesys.so -lutil -lprocstat -lkvm
    check $? "UsageSysLib" "lib/libusagesys.so"

    $CXX $FLAGS lib/kickstart/usage_check.cc -o usage_check lib/libusagesys.so -lutil -lprocstat -lkvm
    check $? "UsageSysCheck" "usage_check"

    $CXX $FLAGS -shared lib/kickstart/stat.cc -o lib/libstat.so
    check $? "StatLib" "lib/libstat.so"

    $CXX $FLAGS -shared lib/kickstart/system_time.cc -o lib/libsystemtime.so -lrt
    check $? "SystemTimeLib" "lib/libsystemtime.so"
fi

if [ "$system" = "Darwin" ]; then
    $CXX $FLAGS -arch i386 -arch x86_64 -shared lib/kickstart/stat.cc -o lib/libstat.dylib
    check $? "StatLib"

    $CXX $FLAGS -arch i386 -arch x86_64 -shared lib/kickstart/system_time.cc -o lib/libsystemtime.dylib -lrt
    check $? "SystemTimeLib"
fi

if [ "$system" = "Linux" ]; then
    $CXX $FLAGS -shared lib/kickstart/system_time.cc -o lib/libsystemtime.so -lrt
    check $? "SystemTimeLib" "lib/libsystemtime.so"
fi
