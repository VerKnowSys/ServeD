#!/bin/sh

if [ "$(id -u)" != "0" ]; then
    echo "Native Installer requires root privileges to run!"
    exit 1
fi

SYSTEM="$(uname)"
ARCH="$(uname -p)"

if [ -e "kick" ]; then
    echo "* Installing svdkick to /sbin"
    cp -f ./kick /sbin/svdkick
else
    echo "! Recompile to install svdkick"
fi

if [ -e "shell" ]; then
    echo "* Installing svdshell to /bin"
    cp -f ./shell /bin/svdshell
else
    echo "! Recompile to install svdshell"
fi

if [ -e "run" ]; then
    echo "* Installing svdrun to /bin"
    cp -f ./run /bin/svdrun
else
    echo "! Recompile to install svdrun"
fi

echo "* Installing native libraries"
if [ ! -d "/lib" ]; then
    mkdir /lib
    if [ "$SYSTEM" = "Darwin" ]; then
        echo "Making /lib hidden"
        chflags hidden /lib
    fi
fi
# NOTE: TODO: maybe use case in case of support for more systems:
if [ "$SYSTEM" = "FreeBSD" ]; then
    cp -fv lib/*.so /lib
    if [ "${ARCH}" = "amd64" ]; then
        mkdir -p /lib32
        echo "* Installing 32bit precompiled libraries for headless mode."
        cp -fv lib32/*.so /lib32
    fi

fi
if [ "$SYSTEM" = "Darwin" ]; then
    cp -fv lib/*.dylib /lib
    chmod 0755 /lib
    # chmod 0644 /lib/*
fi

if [ "$system" = "FreeBSD" ]; then
    echo "* Installing ServeD rc script for FreeBSD"
    cp -fv bin/served /etc/rc.d
    if [ "$(cat /etc/rc.conf | grep served | wc -l)" -gt "0" ]; then
        echo "Autostart entry already in rc.conf"
    else
        echo "served_start=YES" >> /etc/rc.conf
    fi
fi
