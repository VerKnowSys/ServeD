#!/bin/bash
# This Software is a close code project. You may not redistribute this code without permission of author.


. bin/OPTS

echo "Preparing PSTREE library.."
cd lib/pstree/

# 2010-10-24 06:22:29 - dmilith - NOTE: a little hack to be able to distclean without need of running "bin/clean" script
if [ "$1" = "c" ]
then
    make distclean
# else
    # make clean
fi

ulimit -c 0 # don't throw core file on segfault

if [ ! -e 'config.h' ]; then
    ./configure.sh --use-kvm # use kvm lib by default
fi

rm Makefile # replacing auto generated Makefile with prepared one
cp Makefile.$platform Makefile
make

if [ "$?" -eq "0" ]; then
    cd test
    rm -rfv test
    if [ "$platform" = "freebsd" ]; then
        $CC main.c $CFLAGS -o test ../*.o -lkvm
    else
        $CC main.c $CFLAGS -o test ../*.o
    fi
    ./test $@
fi

cd ../../../
echo "Done preparing PSTREE"





echo "Preparing LIBACCT library"
cd lib/acct-6.5.4

if [ "$1" == "c" ]
then
    make distclean
    rm -fr sa.o
    rm -fr test/test
else
    # make clean
    rm -fr sa.o
    rm -fr test/test
fi

if [ ! -e 'config.h' ]; then
    CC=$CC ./configure
fi

if [ "$?" -eq "0" ]; then

    # compile library…
    echo "Compilation…"

    cd lib
    make
    cd ..

srcList=(
common
hashtab
uid_hash
pacct_rd
file_rd
sa
)

    for i in ${srcList[@]}; do
      $CC $CFLAGS $i.c -I./lib/ -c -o $i.o
    done

    echo "Linking library…"
    $CC $CFLAGS -I./lib/ -dynamiclib -o ../libsa.dylib common.o hashtab.o pacct_rd.o uid_hash.o file_rd.o sa.o lib/*.o

    if [ "$?" -eq "0" ]; then
        cd test
        rm -rfv test
        $CC main.c $CFLAGS -o test ../common.o ../hashtab.o ../pacct_rd.o ../uid_hash.o ../file_rd.o ../lib/*.o ../sa.o
        ./test $@
    fi

fi

echo "Done preparing LIBACCT"


