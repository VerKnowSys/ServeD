#!/bin/sh

unset DYLD_LIBRARY_PATH
unset LD_LIBRARY_PATH

SYSTEM_NAME="$(uname -s)"
userUID="$(id -u)"
DEFAULT_COMMON_PATH="/Users/Common"
DEFAULT_USER_UID="${userUID}"
JAVA_PATH="/Software/Openjdk6-i386/exports/java"

# read sofin configuration
. "/etc/profile_sofin"

# read user configuration
. "/Users/${userUID}/.profile"
. "/Users/${userUID}/.profile_java"

if [ "$SYSTEM_NAME" = "Darwin" ]; then
  export JAVA_PATH="/usr/bin/java"
fi

if [ "$1" != "" ]; then
  echo "Explicit UID given: $1."
  export DEFAULT_USER_UID="$1"
fi

echo "Host: ${SYSTEM_NAME}, ServeD UID: ${DEFAULT_USER_UID}, Common path: ${DEFAULT_COMMON_PATH}, JDK: ${JAVA_PATH}."
bin/current
echo "Killing currently spawned user boot for UID: ${DEFAULT_USER_UID}"
kill `cat /Users/${DEFAULT_USER_UID}/${DEFAULT_USER_UID}.pid` > /dev/null 2>&1


case "${SYSTEM_NAME}" in
  Darwin)
    sudo mkdir -p "${DEFAULT_COMMON_PATH}"
    sudo chown ${DEFAULT_USER_UID} "${DEFAULT_COMMON_PATH}"
    sudo bin/ignitersuninstall && sudo bin/ignitersinstall
    sudo chown ${DEFAULT_USER_UID} /Users/${DEFAULT_USER_UID}/.akka.conf
    sleep 3
    "${JAVA_PATH}" -d32 -client -Xmn1m -XX:NewRatio=1 -Xms32m -Xmx256m -Dfile.encoding=UTF-8 -javaagent:/lib/jrebel/jrebel.jar -cp "$(cat tmp/user.classpath)" com.verknowsys.served.userboot ${DEFAULT_USER_UID}
    ;;

  *)
    chown ${DEFAULT_USER_UID} "${DEFAULT_COMMON_PATH}"
    bin/ignitersuninstall && bin/ignitersinstall
    chown ${DEFAULT_USER_UID} /Users/${DEFAULT_USER_UID}/.akka.conf
    sleep 3
    "${JAVA_PATH}" -d32 -client -Xmn1m -XX:NewRatio=1 -Xms32m -Xmx256m -Dfile.encoding=UTF-8 -cp "$(cat tmp/user.classpath)" com.verknowsys.served.userboot ${DEFAULT_USER_UID}
    ;;

esac
