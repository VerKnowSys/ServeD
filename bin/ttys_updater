#!/bin/sh
# author: Daniel (dmilith) Dettlaff
# this script reloads configuration for user ttys assigned to user side svdss

. /etc/sofin.conf.sh

test "$(id -u)" = "0" || error "Updater must be run as root"

TTYS="/etc/ttys"
SVD_SHELL="/bin/svdshell"

cd /Users
for user in *; do
    user_home="/Users/${user}"
    if [ -f "${user_home}/.autostart" ]; then
        note "Autostarting enabled for user: ${user}"
        uid="$(stat -f%u "/Users/${user}")"
        grep -q "${uid}" ${TTYS} || printf "\n# user: ${user}($uid):\nttyv${uid} \"${SVD_SHELL} -u${uid} -- svdss\" xterm on secure\n" >> ${TTYS}

        note "Updating and reloading user initial environment"
        test -f "${user_home}/.profile" || svdshell -u${uid} -- sofin reload 2> /dev/null
        test -f "${user_home}/.zshrc" || printf "# autogenerated default environment:\nexport HISTFILE=${user_home}/.zsh_history\nexport HISTSIZE=8192\nexport SAVEHIST=8192\nsvdpanel" > "${user_home}/.zshrc"
    fi
done

note "Reloading ${TTYS}"
kill -HUP 1
